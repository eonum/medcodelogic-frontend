
@startuml
actor User
control Router <<@angular>> #orange

entity LanguageGuard #lightgreen
entity TranslateService <<Plugin>> #orange
entity CatalogResolver #lightgreen
entity "ICDCatalog \n <<Placeholder for any Catalog>>" as ICD #lightgreen
entity CatalogService #lightgreen
entity CatalogSearchService as SearchService #lightgreen
database search.eonum <<REST API>> #orange
participant AppComponent #lightblue
participant MainComponent #lightblue
participant SearchFormComponent #lightblue
participant SearchResultsComponent as ResultsComp #lightblue

== Load Page / Catalog Search (Without Hierarchy loading) ==

User -> Router: /
activate Router #orange

create AppComponent
Router ->> AppComponent: init
activate AppComponent #lightblue
AppComponent --> Router
deactivate AppComponent

Router -> LanguageGuard: canActivate()?
activate LanguageGuard #lightgreen
LanguageGuard -> LanguageGuard: get browser language ('de')
LanguageGuard ->> Router: navigate('de')
deactivate LanguageGuard

Router -> LanguageGuard: canActivate('de)?

activate LanguageGuard #lightgreen
LanguageGuard ->> TranslateService: setLanguage(de)
LanguageGuard --> Router: grant access
deactivate LanguageGuard

Router -> Router: redirectTo('ICD')
Router ->> CatalogResolver: resolve('de', 'ICD')

activate CatalogResolver #lightgreen
CatalogResolver -> CatalogResolver: getActiveVersion('de', 'ICD')
CatalogResolver ->> Router: navigate('ICD', '2016')
deactivate CatalogResolver

Router ->> CatalogResolver: resolve('de', 'ICD', '2016')

activate CatalogResolver #lightgreen
CatalogResolver -> CatalogResolver: validate('de', 'ICD', '2016')

note left #lightgrey
    If catalog or version does not match,
    redirect to index.
end note

CatalogResolver -> CatalogResolver: activateVersion ('de', 'ICD', '2016')
CatalogResolver --> Router: displayInfos: CatalogDisplayInfos[]


deactivate CatalogResolver

create MainComponent
Router -> MainComponent: init
activate MainComponent #lightblue

MainComponent ->> Router: subscribe to changes
Router ->> MainComponent: {params:{'de', 'ICD', '2016' }, queryParams{query}}

create SearchFormComponent
MainComponent ->> SearchFormComponent: init
activate SearchFormComponent #lightblue

SearchFormComponent -> Router: subscribe to changes
Router ->> SearchFormComponent: {data:{displayInfos},params:{'de', 'ICD', '2016' }, queryParams{query}}
SearchFormComponent -> SearchFormComponent: display catalog selection
SearchFormComponent --> MainComponent
deactivate SearchFormComponent

create ResultsComp
MainComponent ->> ResultsComp : init
activate ResultsComp  #lightblue

ResultsComp -> Router: subscribe to changes
Router ->> ResultsComp: {params:{'de', 'ICD', '2016' }, queryParams{query}}

ResultsComp  ->> SearchService: subscribe to changes
activate SearchService #lightgrey

group search query in route params

    ResultsComp  -> SearchService: search('de', 'ICD', '2016', query)
    activate SearchService #lightgreen

    SearchService ->> ICD: search('de', '2016', query)
    activate ICD #lightgreen
    ICD -> CatalogService: init(self.config)
    activate CatalogService #lightgreen
    CatalogService -> ICD
    ICD ->> CatalogService: search(query)
    CatalogService ->> search.eonum : /de/icds/2016/search?search=query

    activate search.eonum #orange
    search.eonum --> CatalogService: results: json
    deactivate search.eonum

    CatalogService --> ICD: searchResults: CatalogElement[]
    deactivate CatalogService

    ICD --> SearchService: searchResults: CatalogElement[]
    deactivate ICD

    SearchService --> ResultsComp: searchResults:CatalogElement[]
    deactivate SearchService #lightgreen
    ResultsComp  -> ResultsComp : display results

end

ResultsComp --> MainComponent
deactivate ResultsComp

deactivate SearchService

MainComponent --> Router
deactivate MainComponent

Router --> User: display
deactivate Router
@enduml


-------------------------



newpage

== Change Catalog and/or Version, or submit a search query ==

User -> SearchFormComponent: submit catalog or version selection or enter search query, e.g ICD10-GM-2016

activate SearchFormComponent #lightblue
SearchFormComponent --> Router: navigate to 'icds/ICD10-GM-2016;query=query'
deactivate SearchFormComponent

activate Router #orange

Router ->> CatalogResolver: resolve(icds, ICD10-GM-2016)
activate CatalogResolver #lightgreen

CatalogResolver -> CatalogResolver: resolve(icds)

CatalogResolver ->> SwissDrgCatalog: activateVersion(ICD10-GM-2016)

activate SwissDrgCatalog #lightgreen

note left of CatalogResolver #lightgrey
    Catalog and Version match
    (navigated with button)
end note

note over SwissDrgCatalog #lightgrey
    versions are saved
end note

SwissDrgCatalog --> CatalogResolver: success

deactivate SwissDrgCatalog

CatalogResolver --> Router: ICDCatalog: Catalog

deactivate CatalogResolver #lightgreen

Router ->> SearchMainComponent: data:{ICDCatalog}, params:{query?}
activate SearchMainComponent #lightblue

group search query in route params
    SearchMainComponent ->> SwissDrgCatalog: search(query)
    activate SwissDrgCatalog #lightgreen
    SwissDrgCatalog ->> CatalogService: search(query, icds)

    activate CatalogService #lightgreen
    CatalogService ->> search.eonum : /de/icds/ICD10-GM-2016/search?search=query

    activate search.eonum #orange
    search.eonum --> CatalogService: results: json
    deactivate search.eonum

    CatalogService --> SwissDrgCatalog: searchResults: CatalogElement[]
    deactivate CatalogService

    SwissDrgCatalog --> SearchMainComponent: searchResults: CatalogElement[]
    deactivate SwissDrgCatalog

    SearchMainComponent -> ResultsComp : searchResults: CatalogElement[]
    activate ResultsComp  #lightblue
    ResultsComp  -> ResultsComp : display results or message
    ResultsComp  --> SearchMainComponent
    deactivate ResultsComp

end

SearchMainComponent -> SearchFormComponent: ICDCatalog:Catalog
activate SearchFormComponent #lightblue
SearchFormComponent -> SearchFormComponent: mark icd & display query
SearchFormComponent --> SearchMainComponent
deactivate SearchFormComponent

SearchMainComponent --> Router
deactivate SearchMainComponent

Router --> User: display
deactivate Router

newpage

== Change Language ==
User -> AppComponent: select language, e.g. french
activate AppComponent #lightblue

AppComponent -> CatalogResolver: get route parameter to active catalog
activate CatalogResolver #lightgreen
CatalogResolver -> SwissDrgCatalog: getActiveVersion

activate SwissDrgCatalog #lightgreen
SwissDrgCatalog --> CatalogResolver: 'ICD10-GM-2016'
deactivate SwissDrgCatalog

CatalogResolver --> AppComponent: ['icds', 'ICD10-GM-2016']
deactivate CatalogResolver

AppComponent -> Router: navigate to '/fr/icds/ICD10-GM-2016' (ignore query)
deactivate AppComponent

activate Router #orange
Router -> LanguageGuard: canActivate(fr)?

activate LanguageGuard #lightgreen
LanguageGuard -> TranslateService: setLanguage(fr)
LanguageGuard --> Router: grant access
deactivate LanguageGuard

Router ->> CatalogResolver: resolve(icds, ICD10-GM-2016)
activate CatalogResolver #lightgreen

CatalogResolver -> CatalogResolver: resolve(icds)

CatalogResolver ->> SwissDrgCatalog: activateVersion(ICD10-GM-2016)

activate SwissDrgCatalog #lightgreen

note left of CatalogResolver #lightgrey
    Catalog and Version match
    (navigated from valid catalog version)
end note

note over SwissDrgCatalog #lightgrey
    versions are saved
end note

SwissDrgCatalog --> CatalogResolver: success

deactivate SwissDrgCatalog

CatalogResolver --> Router: ICDCatalog: Catalog

deactivate CatalogResolver

Router -> SearchMainComponent: data:{ICDCatalog}, params: {}

activate SearchMainComponent #lightblue
SearchMainComponent -> SearchFormComponent: ICDCatalog:Catalog

activate SearchFormComponent #lightblue
SearchFormComponent -> SearchFormComponent: mark icd & display query
SearchFormComponent --> SearchMainComponent
deactivate SearchFormComponent

SearchMainComponent --> Router
deactivate SearchMainComponent

Router --> User: display
deactivate Router


